version: '3.7'

services:
  projectx-build:
    image: projectx-build
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - projectx 
      
  # projectx-postgres:
  #   image: postgres:12.4
  #   container_name: projectx-postgres
  #   restart: unless-stopped
  #   networks:
  #     - projectx 
  #   ports:
  #     - 5433:5432
  #   environment:
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=root
  # volumes:
  #   - /data/postgresql_data:/var/lib/postgresql/data/

  # projectx-rabbitmq:
  #   image: rabbitmq:3-management
  #   container_name: projectx-rabbitmq
  #   restart: unless-stopped
  #   networks:
  #     - projectx 
  #   ports:
  #     - 15673:15672
  #   environment:
  #     RABBITMQ_DEFAULT_USER: "guest"
  #     RABBITMQ_DEFAULT_PASS: "guest"
  #     RABBITMQ_DEFAULT_VHOST: "/"
  # volumes:
  #   - /data/rabbitmq/data/:/var/lib/rabbitmq/
  #   - /data/rabbitmq/logs/:/var/log/rabbitmq/
  
  # redis:
  #   container_name: projectx-redis
  #   image: 'bitnami/redis:5.0.5'
  #   environment:
  #     #- ALLOW_EMPTY_PASSWORD=yes
  #     - REDIS_PASSWORD=RedisPassword
  #   networks:
  #     - projectx
  #   ports:
  #     - "6379:6379"
  # volumes:
  #   - /data/redis:/bitnami/redis/data  

  # Reverse Proxy
  # projectx-nginx:
  #   image: projectx-nginx
  #   build: 
  #     context: .
  #     dockerfile: nginx/Dockerfile
  #   container_name: projectx-nginx
  #   depends_on:
  #     - projectx-identity   # http://localhost/identity/swagger
  #     - projectx-blog       # http://localhost/blog/swagger
  #     - projectx-messenger  # http://localhost/messenger/swagger
  #     - projectx-realtime   # http://localhost/realtime/swagger WebSocket has not configured for Nginx yet.
  #   networks:
  #     - projectx
  #   ports:
  #     - 80:80

  projectx-identity:
    image: projectx-identity
    build:
      context: .
      dockerfile: src/Services/ProjectX.Identity/ProjectX.Identity.API/Dockerfile
    restart: on-failure
    depends_on:
      - projectx-build
      # - projectx-rabbitmq
      # - projectx-postgres
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5000
      - RabbitMq__Connection__HostName=projectx-rabbitmq
      - RedisOptions__Server__Hosts__0__Host=projectx-redis
      - RedisOptions__Server__Password=RedisPassword
      - IdentityUrl=http://projectx-identity:5000 # for jwt validation
      - ExternalIdentityUrl=http://127.0.0.1:5000 # for swagger
      - ConnectionStrings__DbConnection=Host=projectx-postgres;Database=ProjectX.Identity;Username=postgres;Password=root
    networks:
      - projectx
    ports:
      - "5000:5000" # This is for debugging, we can reach our services through NGINX

  projectx-blog:
    image: projectx-blog
    build:
      context: .
      dockerfile: src/Services/ProjectX.Blog/ProjectX.Blog.API/Dockerfile
    restart: on-failure
    networks:
      - projectx 
    ports:
      - 5001:5001 # This is for debugging, we can reach our services through NGINX
    depends_on:
      - projectx-build
      # - projectx-rabbitmq
      # - projectx-postgres
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5001
      - RabbitMq__Connection__HostName=projectx-rabbitmq
      - IdentityUrl=http://projectx-identity:5000 # for jwt validation
      - ExternalIdentityUrl=http://127.0.0.1:5000 # for swagger
      - ConnectionStrings__DbConnection=Host=projectx-postgres;Database=ProjectX.Blog;Username=postgres;Password=root
  
  projectx-messenger:
    image: projectx-messenger
    build:
      context: .
      dockerfile: src/Services/ProjectX.Messenger/ProjectX.Messenger.API/Dockerfile
    restart: on-failure
    networks:
      - projectx 
    ports:
      - 5002:5002 # This is for debugging, we can reach our services through NGINX
    depends_on:
      - projectx-build
      # - projectx-rabbitmq
      # - projectx-postgres
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5002
      - RabbitMq__Connection__HostName=projectx-rabbitmq
      - IdentityUrl=http://projectx-identity:5000 # for jwt validation
      - ExternalIdentityUrl=http://127.0.0.1:5000 # for swagger
      - ConnectionStrings__DbConnection=Host=projectx-postgres;Database=ProjectX.Messenger;Username=postgres;Password=root

  projectx-realtime:
    image: projectx-realtime
    build:
      context: .
      dockerfile: src/Services/ProjectX.Realtime/ProjectX.Realtime.API/Dockerfile
    restart: on-failure
    networks:
      - projectx 
    ports:
      - 5003:5003
    depends_on:
      - projectx-build
      # - projectx-rabbitmq
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5003
      - RabbitMq__Connection__HostName=projectx-rabbitmq
      - IdentityUrl=http://projectx-identity:5000 # for jwt validation
      - ExternalIdentityUrl=http://127.0.0.1:5000 # for swagger

networks:
  projectx:
    name: projectx-network
    external: true